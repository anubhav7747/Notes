# Network Address Translation (NAT)
Network Address Translation (NAT) is a technique used in computer networking to modify network address information in packet headers while in transit. The primary purpose of NAT is to conserve IP addresses by allowing multiple devices within a private network to share a single public IP address when communicating with external networks like the Internet. NAT operates at the network layer (Layer 3) of the OSI model and is commonly used in home and small office networks.

The basic idea behind NAT is to assign each company a single **public IP address** (or at most, a small number of them) for Internet traffic. Within the company, every computer gets a unique IP address, which is used for routing intramural traffic (within the walls of a building). However, when a packet exits the company and goes to the ISP, an address translation takes place. To make this scheme possible, three ranges of IP addresses have been declared as **private**. Companies may use them internally as they wish. The only rule is that no packets containing these addresses may appear on the Internet itself.

The three reserved ranges are:
1. 10.0.0.0 - 10.255.255.255/8 (16,777,216 hosts)
2. 172.16.0.0 - 172.16.255.255/12 (1,048,576 hosts)
3. 192.168.0.0 - 192.168.255.255/16 (65,536 hosts)

Within the company premises, every machine has a unique address of the form 10.x.y.z. However, when a packet leaves the company premises, it passes through a **NAT box** that converts the internal IP source address, 10.0.0.1 in the figure, to the company's true IP address, 198.60.42.12 in this example.

  ![image](https://github.com/anubhav7747/Notes/assets/77168708/974bcc95-8000-4d93-9af6-dd782b805f76)

- The NAT box is often combined in a single device with a firewall, which provides security by carefully controlling what goes into the company and what comes out.
- The Nat designers observed that most IP packets carry either TCP or UDP payloads. So, when a packet reaches the NAT box, it replaces the source IP address 10.0.0.1 with company's public IP and saves source IP and source port number in table that it  maintains. The index of this table entry replaces the source port address of this outgoing packet. Hence now the packet has public IP as source IP in IP header part and table index as source port address in TCP header part. Finally, both the IP and TCP header checksums are recomputed and inserted into the packet.
- When a packet arrives at the NAT box from the ISP, the Source port in the TCP header is extracted and used as an index into the NAT box's mapping table. From the entry located, the internal IP address and original TCP Source port are extracted and inserted into the packet.
- Then both the IP and TCP checksums are recomputed and inserted into the packet. The packet is then passed to the company router for normal delivery using the 10.x.y.z address.
- NAT can also be used to alleviate the IP shortage for ADSL and cable users. When the ISP assigns each user an address, it uses 10.x.y.z addresses. When packets from user machines exit the ISP and enter the main Internet, they pass through a NAT box that translates them to the ISP's true Internet address. On the way back, packets undergo the reverse mapping. In this respect, to the rest of the Internet, the ISP and its home ADSL/cable users just looks like a big company.

Although this scheme sort of solves the problem, many people in the IP community regard it as an abomination-on-the-face-of-the-earth. Briefly summarized, here are some of the objections
1. NAT violates the architectural model of IP, which states that every IP address uniquely identifies a single machine worldwide. The whole software structure of the Internet is built on this fact. With NAT, thousands of machines may (and do) use address 10.0.0.1.
2. NAT changes the Internet from a connectionless network to a kind of connection-oriented network. The problem is that the NAT box must maintain information (the mapping) for each connection passing through it. Having the network maintain connection state is a property of connection-oriented networks, not connectionless ones. If the NAT box crashes and its mapping table is lost, all its TCP connections are destroyed. In the absence of NAT, router crashes have no effect on TCP. The sending process just times out within a few seconds and retransmits all unacknowledged packets. With NAT, the Internet becomes as vulnerable as a circuit-switched network.
3. NAT violates the most fundamental rule of protocol layering: layer **k** may not make any assumptions about what layer **k + 1** has put into the payload field. This basic principle is there to keep the layers independent. If TCP is later upgraded to TCP-2, with a different header layout (e.g., 32-bit ports), NAT will fail. The whole idea of layered protocols is to ensure that changes in one layer do not require changes in other layers. NAT destroys this independence.
4. Processes on the Internet are not required to use TCP or UDP. If a user on machine **A** decides to use some new transport protocol to talk to a user on machine **B** (for example, for a multimedia application), introduction of a NAT box will cause the application to fail because the NAT box will not be able to locate the TCP Source port correctly.
5. Some applications insert IP addresses in the body of the text. The receiver then extracts these addresses and uses them. Since NAT knows nothing about these addresses, it cannot replace them, so any attempt to use them on the remote side will fail. FTP, the standard **File Transfer Protocol** works this way and can fail in the presence of NAT unless special precautions are taken.
6. Since the TCP Source port field is 16 bits, at most 65,536 machines can be mapped onto an IP address. Actually, the number is slightly less because the first 4096 ports are reserved for special uses. However, if multiple IP addresses are available, each one can handle up to 61,440 machines.

**_In general, the opponents of NAT say that by fixing the problem of insufficient IP address with a temporary and ugly hack, the pressure to implement the real solution, that is, the transition to IPv6, is reduced, and this is a bad thing._**
